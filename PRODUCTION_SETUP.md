# 本番環境への移行ガイド

## 1. Google OAuth設定の更新

### 1.1 「このアプリはGoogleで確認されていません」エラーの解決

ログイン時に「このアプリはGoogleで確認されていません」という警告が表示される場合、以下のいずれかの方法で解決できます：

#### 方法A: OAuth同意画面を公開（推奨・本番環境用）

**⚠️ 重要**: アプリを公開すると、すべてのGoogleユーザーがログイン可能になります。ただし、機密スコープ（Calendar APIなど）を使用している場合は、Googleの検証プロセスが必要な場合があります。

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクト「study-planner」を選択
3. 「APIとサービス」→「OAuth同意画面」を開く
4. 「公開ステータス」セクションを確認
5. 「公開する」ボタンをクリック
6. 警告が表示される場合は内容を確認：
   - **外部ユーザー向け**の場合：Googleの検証が必要な場合があります
   - **内部ユーザー向け**の場合（Google Workspaceを使用している場合）：検証なしで公開可能
7. 「公開」を確認

**検証が必要な場合：**
- GoogleカレンダーAPIなどの機密スコープを使用している場合、Googleの審査が必要
- 審査には数日〜数週間かかる場合がある
- 審査中は「テスト中」のまま、テストユーザーを追加して使用可能

#### 方法B: テストユーザーとして追加（一時的な解決策）

すぐにログイン可能にしたい場合は、使用したいユーザーをテストユーザーとして追加：

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクト「study-planner」を選択
3. 「APIとサービス」→「OAuth同意画面」を開く
4. 「テストユーザー」セクションまでスクロール
5. 「ユーザーを追加」をクリック
6. ログインさせたいGoogleアカウントのメールアドレスを入力
7. 「追加」をクリック
8. 追加したユーザーは、警告画面で「詳細」→「（安全でないページ）に移動」をクリックしてログイン可能

**注意**: テストユーザーは最大100人まで追加可能です。

### 1.2 アプリの検証プロセス（必要に応じて）

機密スコープを使用している場合、Googleの検証が必要：

1. OAuth同意画面で「公開」を試みる
2. 検証が必要な場合は警告が表示される
3. 「検証を開始」をクリック
4. 必要な情報を入力：
   - プライバシーポリシーのURL（必須）
   - 利用規約のURL（推奨）
   - アプリの説明
   - スクリーンショット
   - 連絡先情報
5. 検証プロセスを完了

**プライバシーポリシーを作成する場合：**
- 簡単なプライバシーポリシーをアプリのWebサイトに追加
- または、[プライバシーポリシー生成ツール](https://www.freeprivacypolicy.com/)を使用

### 1.3 承認済みリダイレクトURIの確認

以下のURIが「承認済みリダイレクトURI」に登録されていることを確認：

- `https://project-omega-weld.vercel.app/api/auth/callback/google`

必要に応じて、カスタムドメインを使用する場合は、そのドメインも追加してください。

## 2. 環境変数の確認

### 2.1 重要な注意事項

**⚠️ ログイン画面で別のアプリ名（例: "folder-rules-sync"）が表示される場合**

これは、`GOOGLE_CLIENT_ID`環境変数が誤ったプロジェクトのOAuth Client IDに設定されている可能性があります。

**正しいOAuth Client IDの形式:**
- 先頭が `259584654504-h86ohpa6trnsif0falig3qssg55r7aap` で始まる
- Google Cloud Consoleの「study-planner」プロジェクトから取得したもの

**確認方法:**

1. 以下のエンドポイントで現在の設定を確認（一時的にデバッグモードを有効化）：
   ```
   https://project-omega-weld.vercel.app/api/auth/verify-config
   ```
   ※ デバッグモードが無効な場合は、Vercelの環境変数で `ENABLE_AUTH_DEBUG=true` を設定

2. Vercelダッシュボードで `GOOGLE_CLIENT_ID` を確認：
   - 「study-planner」プロジェクトのOAuth Client IDであることを確認
   - 誤った場合は、Google Cloud Consoleから正しいClient IDを取得して更新

### 2.2 必要な環境変数

Vercelダッシュボードで以下の環境変数が正しく設定されていることを確認：

- `GOOGLE_CLIENT_ID` - Google OAuth Client ID（**「study-planner」プロジェクトのもの**）
- `GOOGLE_CLIENT_SECRET` - Google OAuth Client Secret（**「study-planner」プロジェクトのもの**）
- `NEXTAUTH_URL` - 本番URL（例: `https://project-omega-weld.vercel.app`）
- `NEXTAUTH_SECRET` - NextAuth用の秘密鍵
- `DATABASE_URL` - PostgreSQLデータベースURL
- `TZ` - タイムゾーン（例: `Asia/Tokyo`）

### 2.3 正しいOAuth Client IDの取得方法

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. **「study-planner」プロジェクト**を選択（重要）
3. 「APIとサービス」→「認証情報」を開く
4. 「OAuth 2.0 クライアントID」セクションを確認
5. 正しいClient IDをコピー（先頭が `259584654504-h86ohpa6trnsif0falig3qssg55r7aap` で始まる）
6. Vercelダッシュボードで `GOOGLE_CLIENT_ID` 環境変数を更新

## 3. セキュリティ設定

### 3.1 デバッグエンドポイントの削除

✅ **完了済み**: デバッグエンドポイント（`/api/debug/*`）は削除されました

### 3.2 デバッグログの無効化

✅ **完了済み**: 本番環境ではデバッグログが自動的に無効化されます

環境変数 `ENABLE_AUTH_DEBUG=true` を設定することで、必要に応じてデバッグログを有効化できます（トラブルシューティング時のみ使用）

## 4. データベースの準備

### 4.1 マイグレーションの確認

以下のマイグレーションが適用されていることを確認：

- `refresh_token_expires_in` フィールドが `Account` モデルに追加されている

### 4.2 データベースバックアップ

本番環境に移行する前に、既存データのバックアップを推奨：

```bash
# データベースのバックアップ（Prisma Accelerateを使用している場合）
# Vercelダッシュボードからデータベースのバックアップを取得
```

## 5. 動作確認チェックリスト

本番環境に移行後、以下を確認：

- [ ] 新しいGoogleアカウントでログインできる
- [ ] ユーザー情報が正しく表示される
- [ ] セッションが正しく維持される
- [ ] ログアウトが正常に動作する
- [ ] データの作成・更新・削除が正常に動作する

## 6. トラブルシューティング

### 6.1 「このアプリはGoogleで確認されていません」エラー

**エラーの意味:**
- OAuth同意画面が「テスト中」の状態
- 現在ログインしようとしているユーザーがテストユーザーリストに含まれていない

**解決方法:**

1. **テストユーザーとして追加（即座に解決）:**
   - Google Cloud Console → OAuth同意画面 → 「テストユーザー」にメールアドレスを追加

2. **アプリを公開（推奨）:**
   - OAuth同意画面で「公開する」をクリック
   - 検証が必要な場合は、プライバシーポリシーなどの情報を提供

3. **警告画面で進む（非推奨）:**
   - 「詳細」をクリック
   - 「（安全でないページ）に移動」をクリック
   - ⚠️ これはセキュリティ上の警告を無視するため、推奨されません

### 6.2 ログインできない場合

1. Google Cloud ConsoleでOAuth同意画面が「公開」になっているか確認
2. テストユーザーとして追加されているか確認（「テスト中」の場合）
3. リダイレクトURIが正しく設定されているか確認
4. Vercelのログでエラーを確認

### 6.2 デバッグログを有効化する場合

Vercelの環境変数に以下を追加：

```
ENABLE_AUTH_DEBUG=true
```

**注意**: デバッグログを有効化すると、ログに機密情報が表示される可能性があります。トラブルシューティングが完了したら、必ず無効化してください。

## 7. モニタリング

本番環境では、以下を監視してください：

- エラーログの監視（Vercel Dashboard）
- データベース接続の監視
- 認証エラーの監視

## 8. サポート

問題が発生した場合：

1. Vercelのログを確認
2. Google Cloud ConsoleのOAuth設定を確認
3. データベースの状態を確認（Prisma Studioなど）

